<!doctype html><html lang="id"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="description" content="StoryApp - Bagikan cerita Anda dengan lokasi"/><link rel="manifest" href="manifest.json"/><meta name="theme-color" content="#0dcaf0"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/><meta name="apple-mobile-web-app-title" content="StoryApp"/><link rel="apple-touch-icon" href="images/icons/ios/192.png"/><link rel="shortcut icon" href="favicon.png"/><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/><link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css"/><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"><title>StoryApp</title><style>:root {
          --primary: #0dcaf0;
          --primary-dark: #0bacce;
          --secondary: #6c757d;
          --accent: #fd7e14;
          --background: #f8f9fa;
          --text: #212529;
          --light-text: #6c757d;
          --border: #dee2e6;
          --notification-bg: #f0f7ff;
          --notification-unread: #e1f0ff;
          --danger: #dc3545;
          --success: #198754;
        }
        
        body {
          font-family: 'Poppins', sans-serif;
          background-color: var(--background);
          color: var(--text);
          position: relative;
          min-height: 100vh;
          display: flex;
          flex-direction: column;
        }
        
        .hidden { 
          display: none !important; 
        }
        
        .skip-link { 
          position: absolute; 
          top: -40px; 
          left: 0; 
          background: var(--primary-dark); 
          color: white; 
          padding: 8px; 
          z-index: 100; 
          text-decoration: none;
          transition: top 0.3s;
        }
        
        .skip-link:focus { 
          top: 0; 
        }
        
        /* Navbar styling */
        .navbar {
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          padding: 12px 0;
        }
        
        .navbar-brand {
          font-weight: 600;
          display: flex;
          align-items: center;
        }
        
        .navbar-brand img.logo { 
          height: 32px; 
          margin-right: 10px; 
        }
        
        .nav-link {
          font-weight: 500;
          padding: 8px 16px !important;
          border-radius: 4px;
          transition: all 0.3s ease;
        }
        
        .nav-link:hover {
          background-color: rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary {
          background-color: var(--accent);
          border-color: var(--accent);
          font-weight: 500;
          padding: 8px 20px;
          border-radius: 4px;
          transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
          background-color: #e67211;
          border-color: #e67211;
          transform: translateY(-2px);
        }
        
        .btn-outline-light {
          font-weight: 500;
          padding: 8px 20px;
          border-radius: 4px;
          transition: all 0.3s ease;
        }
        
        .btn-outline-light:hover {
          transform: translateY(-2px);
        }
        
        /* Notification styling */
        .notification-bell { 
          position: fixed; 
          top: 80px; 
          right: 30px; 
          background-color: var(--primary); 
          color: white; 
          border: none; 
          border-radius: 50%; 
          width: 48px; 
          height: 48px; 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          cursor: pointer; 
          font-size: 22px; 
          box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
          z-index: 1050;
          transition: transform 0.3s ease, background-color 0.3s ease;
        }
        
        .notification-bell:hover {
          transform: scale(1.1);
          background-color: var(--primary-dark);
        }
        
        .notification-badge { 
          position: absolute; 
          top: -5px; 
          right: -5px; 
          background-color: var(--danger); 
          color: white; 
          border-radius: 50%; 
          width: 22px; 
          height: 22px; 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          font-size: 12px; 
          font-weight: bold;
          border: 2px solid white;
        }
        
        .notifications-panel { 
          position: fixed; 
          right: 30px; 
          top: 140px; 
          width: 350px; 
          max-height: 500px; 
          background-color: white; 
          border-radius: 12px; 
          box-shadow: 0 5px 25px rgba(0,0,0,0.15); 
          overflow: hidden; 
          z-index: 1040;
          transition: transform 0.3s ease;
          transform-origin: top right;
        }
        
        .notifications-header { 
          display: flex; 
          justify-content: space-between; 
          align-items: center; 
          padding: 16px 20px; 
          background-color: var(--primary); 
          color: white; 
        }
        
        .notifications-title { 
          margin: 0; 
          font-weight: 600;
          font-size: 1.1rem;
        }
        
        .close-notifications { 
          background: none; 
          border: none; 
          color: white; 
          font-size: 24px; 
          cursor: pointer;
          transition: transform 0.2s ease;
        }
        
        .close-notifications:hover {
          transform: scale(1.2);
        }
        
        .notifications-actions { 
          padding: 12px 20px; 
          background-color: #f5f5f5; 
          border-bottom: 1px solid var(--border); 
          text-align: right; 
        }
        
        .notifications-list { 
          list-style: none; 
          margin: 0; 
          padding: 0; 
          max-height: 350px; 
          overflow-y: auto; 
        }
        
        .notification-item { 
          padding: 16px 20px; 
          border-bottom: 1px solid var(--border); 
          position: relative; 
          cursor: pointer;
          transition: background-color 0.2s ease;
        }
        
        .notification-item h4 {
          font-size: 1rem;
          font-weight: 600;
          margin-bottom: 5px;
          padding-right: 30px;
        }
        
        .notification-item p {
          font-size: 0.9rem;
          margin-bottom: 8px;
          color: var(--light-text);
        }
        
        .notification-item small {
          font-size: 0.75rem;
          color: var(--light-text);
        }
        
        .notification-item:hover {
          background-color: #f9f9f9;
        }
        
        .notification-item.unread { 
          background-color: var(--notification-unread);
          border-left: 4px solid var(--primary);
        }
        
        .notification-item.unread:hover {
          background-color: var(--notification-bg);
        }
        
        .notification-delete { 
          position: absolute; 
          top: 16px; 
          right: 16px; 
          background: none; 
          border: none; 
          color: var(--danger); 
          font-size: 16px; 
          cursor: pointer;
          opacity: 0.6;
          transition: opacity 0.2s ease, transform 0.2s ease;
        }
        
        .notification-delete:hover { 
          opacity: 1;
          transform: scale(1.1);
        }
        
        .no-notifications { 
          padding: 30px 20px; 
          text-align: center; 
          color: var(--light-text);
          font-style: italic;
        }
        
        /* Main content */
        .main-content { 
          padding-top: 80px;
          flex: 1;
        }
        
        /* Footer */
        footer { 
          background-color: var(--primary); 
          color: white;
          padding: 25px 0; 
          text-align: center; 
          margin-top: 40px;
        }
        
        footer p {
          margin-bottom: 0;
        }
        
        /* Sweet Alert customization */
        .swal2-popup {
          font-family: 'Poppins', sans-serif;
          border-radius: 12px;
        }
        
        .swal2-title {
          font-weight: 600;
        }
        
        .swal2-confirm {
          background-color: var(--primary) !important;
          border-radius: 4px !important;
        }
        
        .swal2-cancel {
          border-radius: 4px !important;
        }
        
        /* Animation styles */
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        
        .fadeIn {
          animation: fadeIn 0.3s ease forwards;
        }</style><script defer="defer" src="app.bundle.js"></script><link href="app.css" rel="stylesheet"></head><body><a href="#main-content" class="skip-link">Lewati ke konten utama</a><header><nav class="navbar navbar-expand-lg navbar-dark bg-info fixed-top"><div class="container"><a class="navbar-brand" href="#/"><img src="images/logo.png" alt="Logo StoryApp" class="logo d-inline-block align-text-top"/> StoryApp </a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navigation-drawer" aria-controls="navigation-drawer" aria-expanded="false" aria-label="Tombol menu"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navigation-drawer"><ul class="navbar-nav ms-auto mb-2 mb-lg-0"><li class="nav-item"><a class="nav-link" href="#/"><i class="fas fa-home me-1"></i> Beranda</a></li><li class="nav-item"><a class="nav-link" href="#/map"><i class="fas fa-map-location-dot me-1"></i> Tampilan Peta</a></li><li id="nav-add-story" class="nav-item hidden"><a class="nav-link" href="#/add"><i class="fas fa-plus-circle me-1"></i> Tambah Cerita</a></li><li class="nav-item"><a class="nav-link" href="#/about"><i class="fas fa-info-circle me-1"></i> Tentang</a></li><li id="nav-logout" class="nav-item hidden"><button id="logout-btn" class="btn btn-outline-light ms-lg-2"><i class="fas fa-sign-out-alt me-1"></i> Keluar</button></li><li id="nav-login" class="nav-item"><a class="nav-link" href="#/login"><i class="fas fa-sign-in-alt me-1"></i> Masuk</a></li><li id="nav-register" class="nav-item"><a class="btn btn-primary ms-lg-2" href="#/register"><i class="fas fa-user-plus me-1"></i> Daftar</a></li></ul></div></div></nav></header><button id="notification-bell" class="notification-bell hidden" aria-label="Notifikasi"><i class="fas fa-bell"></i> <span id="notification-badge" class="notification-badge" style="display:none">0</span></button><div id="notifications-panel" class="notifications-panel hidden"><div class="notifications-header"><h3 class="notifications-title"><i class="fas fa-bell me-2"></i>Notifikasi</h3><button id="close-notifications" class="close-notifications" aria-label="Tutup"><i class="fas fa-times"></i></button></div><div class="notifications-actions"><button id="mark-all-read" class="btn btn-sm btn-light"><i class="fas fa-check-double me-1"></i> Tandai Semua Dibaca</button></div><ul id="notifications-list" class="notifications-list"><li class="no-notifications">Tidak ada notifikasi</li></ul></div><div class="mt-3"></div><main id="main-content" tabindex="2" class="main-content container mt-5 pt-3"><p>Konten utama halaman...</p></main><footer class="mt-10"><div class="container"><p>&copy; 2025 StoryApp - Bagikan cerita Anda dengan lokasi</p><div class="mt-2"><a href="#" class="text-white me-3"><i class="fab fa-facebook-f"></i></a> <a href="#" class="text-white me-3"><i class="fab fa-twitter"></i></a> <a href="#" class="text-white me-3"><i class="fab fa-instagram"></i></a> <a href="#" class="text-white"><i class="fab fa-github"></i></a></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script><script>// Navigation and Auth
        const navLogin = document.getElementById('nav-login');
        const navRegister = document.getElementById('nav-register');
        const navAddStory = document.getElementById('nav-add-story');
        const navLogout = document.getElementById('nav-logout');
        const bell = document.getElementById('notification-bell');
        const badge = document.getElementById('notification-badge');
        const panel = document.getElementById('notifications-panel');
        const closeBtn = document.getElementById('close-notifications');
        const markAllBtn = document.getElementById('mark-all-read');
        const listEl = document.getElementById('notifications-list');

        let notifications = [];
        let unreadCount = 0;

        function updateNav() {
          const authData = JSON.parse(localStorage.getItem('storyapp_auth'));
          const logged = !!authData?.token;
          if (logged) {
            navLogin.classList.add('hidden');
            navRegister.classList.add('hidden');
            navAddStory.classList.remove('hidden');
            navLogout.classList.remove('hidden');
            bell.classList.remove('hidden');
          } else {
            navLogin.classList.remove('hidden');
            navRegister.classList.remove('hidden');
            navAddStory.classList.add('hidden');
            navLogout.classList.add('hidden');
            bell.classList.add('hidden');
          }
        }

        document.getElementById('logout-btn')?.addEventListener('click', () => {
          Swal.fire({
            title: 'Keluar',
            text: 'Apakah Anda yakin ingin keluar?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Ya, Keluar',
            cancelButtonText: 'Batal',
            confirmButtonColor: '#0dcaf0',
            cancelButtonColor: '#6c757d',
          }).then((result) => {
            if (result.isConfirmed) {
              localStorage.removeItem('storyapp_auth');
              Swal.fire({
                title: 'Berhasil Keluar',
                text: 'Anda telah berhasil keluar dari akun',
                icon: 'success',
                confirmButtonColor: '#0dcaf0',
                timer: 2000,
                timerProgressBar: true
              }).then(() => {
                window.location.href = '#/';
                window.location.reload();
              });
            }
          });
        });

        // Notification UI
        function formatTime(ts) {
          return new Date(ts).toLocaleString('id-ID', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
        }
        
        function updateBadge() {
          if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badge.style.display = 'flex';
          } else badge.style.display = 'none';
        }
        
        function renderNotifications() {
          listEl.innerHTML = ''; 
          if (!notifications.length) return listEl.innerHTML = '<li class="no-notifications"><i class="fas fa-inbox me-2"></i>Tidak ada notifikasi</li>';
          
          notifications.forEach(n => {
            const li = document.createElement('li');
            li.className = n.read ? 'notification-item' : 'notification-item unread';
            li.dataset.id = n.id;
            
            li.innerHTML = `
              <h4>${n.title}</h4>
              <p>${n.options.body}</p>
              <small><i class="far fa-clock me-1"></i>${formatTime(n.timestamp)}</small>
              <button class="notification-delete" aria-label="Hapus"><i class="fas fa-trash-alt"></i></button>
            `;
            
            li.addEventListener('click', () => markAsRead(n.id));
            li.querySelector('.notification-delete').addEventListener('click', e => { 
              e.stopPropagation(); 
              confirmDeleteNotification(n.id); 
            });
            
            listEl.appendChild(li);
          });
        }

        function markAsRead(id) {
          navigator.serviceWorker.controller.postMessage({ type:'MARK_AS_READ', id });
          
          // Ganti dengan SweetAlert untuk konfirmasi
          const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
          });
          
          Toast.fire({
            icon: 'success',
            title: 'Notifikasi ditandai sebagai dibaca'
          });
        }
        
        function confirmDeleteNotification(id) {
          Swal.fire({
            title: 'Hapus notifikasi?',
            text: 'Anda tidak dapat mengembalikan notifikasi yang dihapus',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Hapus',
            cancelButtonText: 'Batal',
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
          }).then((result) => {
            if (result.isConfirmed) {
              deleteNotification(id);
            }
          });
        }
        
        function deleteNotification(id) {
          navigator.serviceWorker.controller.postMessage({ type:'DELETE_NOTIFICATION', id });
          
          const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
          });
          
          Toast.fire({
            icon: 'success',
            title: 'Notifikasi berhasil dihapus'
          });
        }

        bell.addEventListener('click', () => {
          panel.classList.toggle('hidden');
          if (!panel.classList.contains('hidden')) {
            panel.classList.add('fadeIn');
          }
        });
        
        closeBtn.addEventListener('click', () => panel.classList.add('hidden'));
        
        markAllBtn.addEventListener('click', () => {
          if (unreadCount > 0) {
            navigator.serviceWorker.controller.postMessage({ type:'MARK_ALL_AS_READ' });
            
            Swal.fire({
              title: 'Semua Dibaca',
              text: 'Semua notifikasi telah ditandai sebagai dibaca',
              icon: 'success',
              confirmButtonColor: '#0dcaf0',
              timer: 2000,
              timerProgressBar: true
            });
          } else {
            Swal.fire({
              title: 'Info',
              text: 'Tidak ada notifikasi yang belum dibaca',
              icon: 'info',
              confirmButtonColor: '#0dcaf0',
              timer: 2000,
              timerProgressBar: true
            });
          }
        });

        // Service Worker registration & messaging
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', async () => {
            try {
              const reg = await navigator.serviceWorker.register('/sw.js');
              console.log('Service worker berhasil didaftarkan:', reg);
              
              const authData = JSON.parse(localStorage.getItem('storyapp_auth'));
              if (reg.active && authData?.token) {
                reg.active.postMessage({ type:'AUTH_TOKEN', token:authData.token });
                reg.active.postMessage({ type:'GET_DUMMY_NOTIFICATIONS_STATUS' });
                reg.active.postMessage('FLUSH_NOTIFICATIONS');
              }
              
              navigator.serviceWorker.addEventListener('message', ({ data }) => {
                if (data.type==='PENDING_NOTIFICATIONS') {
                  notifications = data.notifications;
                  unreadCount = notifications.filter(n => !n.read).length;
                } else if (data.type==='NEW_NOTIFICATION') {
                  notifications.unshift(data.notification);
                  if (!data.notification.read) {
                    unreadCount++;
                    // Tampilkan SweetAlert untuk notifikasi baru
                    const Toast = Swal.mixin({
                      toast: true,
                      position: 'top-end',
                      showConfirmButton: false,
                      timer: 5000,
                      timerProgressBar: true
                    });
                    
                    Toast.fire({
                      icon: 'info',
                      title: data.notification.title,
                      text: data.notification.options.body
                    });
                  }
                } else if (data.type==='NOTIFICATION_DELETED') {
                  const deletedItem = notifications.find(n => n.id === data.id);
                  if (deletedItem && !deletedItem.read) {
                    unreadCount = Math.max(0, unreadCount - 1);
                  }
                  notifications = notifications.filter(n => n.id!==data.id);
                } else if (data.type==='NOTIFICATIONS_MARKED_READ') {
                  notifications.forEach(n => n.read = true);
                  unreadCount = 0;
                } else if (data.type==='DUMMY_NOTIFICATIONS_STATUS') {
                  // ignore
                }
                updateBadge(); 
                renderNotifications();
              });
            } catch (error) {
              console.error('Gagal mendaftarkan service worker:', error);
              Swal.fire({
                title: 'Error',
                text: 'Gagal mendaftarkan service worker. Beberapa fitur mungkin tidak berfungsi dengan baik.',
                icon: 'error',
                confirmButtonColor: '#0dcaf0'
              });
            }
          });
        } else {
          console.log('Service Worker tidak didukung oleh browser ini');
          Swal.fire({
            title: 'Peringatan',
            text: 'Browser Anda tidak mendukung Service Worker. Beberapa fitur mungkin tidak berfungsi dengan baik.',
            icon: 'warning',
            confirmButtonColor: '#0dcaf0'
          });
        }

        // Menambahkan welcome alert ketika halaman pertama kali dimuat
        window.addEventListener('DOMContentLoaded', () => {
          const visitedBefore = localStorage.getItem('visited_before');
          if (!visitedBefore) {
            setTimeout(() => {
              Swal.fire({
                title: 'Selamat Datang di StoryApp!',
                text: 'Bagikan cerita dan pengalaman Anda dengan lokasi. Daftar atau masuk untuk mulai menggunakan aplikasi.',
                icon: 'info',
                confirmButtonColor: '#0dcaf0',
                confirmButtonText: 'Mulai'
              });
              localStorage.setItem('visited_before', 'true');
            }, 1000);
          }
        });

        // Inisialisasi
        updateNav();</script></body></html>